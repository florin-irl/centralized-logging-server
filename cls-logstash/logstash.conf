input {
    tcp {
        port => 5044
        codec => json
    }
}

filter {
    # Extract nested "service" if present
    if ![service] and [Properties][service] {
        mutate {
            add_field => { "service" => "%{[Properties][service]}" }
        }
    }

    # Extract timestamp if missing (optional)
    if ![timestamp] {
        mutate {
            add_field => { "timestamp" => "%{+YYYY-MM-dd HH:mm:ss}" }
        }
    }

    # Default fallback
    if ![service] {
        mutate {
            add_field => { "service" => "unknown" }
        }
    }
}

output {
    stdout {
        codec => rubydebug
    }

    file {
        path => "/usr/share/logstash/logs/centralized.log"
        codec => json_lines
    }

    elasticsearch {
        hosts => ["http://elasticsearch:9200"]
        index => "%{service}-logs-%{+YYYY.MM.dd}"
    }
}
